<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Calculator</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    .small{font-size:.95rem;color:#555}
    .row{display:flex;gap:8px;align-items:center}
    .calculator-layout {display:flex;gap:20px;margin-top:20px;}
    .calc-form-container {flex:1;min-width:350px;}
    .activity-data-container {flex:2; max-height:700px; overflow:auto; background:#fff;padding:12px;border:1px solid #ddd;border-radius:8px;}
    label {display:block;margin-bottom:6px;font-weight:600}
  </style>
</head>
<body>
  <header>
    <nav>
      <h1>ðŸŒ¿ Carbon Emission dashboard for mining activity</h1>
      <ul>
        <li><a href="/">Home</a></li>
        <li><a href="/concepts">GHG Concepts</a></li>
        <li><a href="/calculator">Calculator</a></li>
        <li><a href="/dashboard">Dashboard</a></li>
        <li><a href="{{ url_for('logout') }}">Logout</a></li>
      </ul>
    </nav>
  </header>

  <main style="padding:18px;">
    <div class="user-details" style="background:#eef;padding:8px;border-radius:6px;margin-bottom:14px;">
      <strong>Nodal Person:</strong> {{ user.nodal_person or 'N/A' }} |
      <strong>Company:</strong> {{ user.company or 'N/A' }} |
      <strong>Email:</strong> {{ user.email or 'N/A' }}
    </div>

    <div class="calculator-layout">
      <div class="calc-form-container">
        <h3>New Emission Entry</h3>
        <form method="post" id="calcForm">
          <label for="processSel">Select Process</label>
          <select id="processSel" name="process" required>
            <option value="">-- Select process --</option>
            {% for p in processes %}
              <option value="{{ p['process_code'] }}">{{ p['process_desc'] }} ({{ p['scope'] }})</option>
            {% endfor %}
          </select>

          <div id="dynamicFields" style="margin-top:12px"></div>

          <div style="margin-top:12px">
            <button type="submit">Calculate & Save Emission</button>
          </div>
        </form>
      </div>

      <div class="activity-data-container">
        <h3>Your Recent Activity Data (Last 10 Entries)</h3>
        <table border="1" style="width:100%;border-collapse:collapse;">
          <thead>
            <tr><th>ID</th><th>Process</th><th>Inputs</th><th>Factor</th><th>Emission (kg CO2e)</th><th>Date</th></tr>
          </thead>
          <tbody>
            {% if activities|length == 0 %}
              <tr><td colspan="6">No recent activity recorded.</td></tr>
            {% else %}
              {% for a in activities %}
                <tr>
                  <td>{{ a.id }}</td>
                  <td>{{ a.process_desc }}</td>
                  <td>{{ a.input_value_str }}</td>
                  <td>{{ '%.4f'|format(a.factor_used) }}</td>
                  <td>{{ '%.3f'|format(a.emission) }}</td>
                  <td>{{ a.created_at }}</td>
                </tr>
              {% endfor %}
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </main>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const sel = document.getElementById('processSel');
  const dyn = document.getElementById('dynamicFields');

  function clearDyn() { dyn.innerHTML = ''; }

  async function loadQuestions(code) {
    clearDyn();
    if(!code) return;
    try {
      const res = await fetch(`/get_questions/${encodeURIComponent(code)}`);
      if(!res.ok) { dyn.innerHTML = '<p style="color:red">Could not load questions.</p>'; return; }
      const js = await res.json();
      const fields = js.questions || [];
      if(fields.length === 0) {
        // fallback single quantity
        dyn.innerHTML = `
          <label>Enter quantity</label>
          <div class="row">
            <input type="number" name="quantity" step="any" required style="flex:1;padding:6px" />
            <div class="small" style="padding:6px">units</div>
          </div>`;
        return;
      }
      fields.forEach(f => {
        const key = f.key;
        const q = f.question;
        const unit = f.unit || '';
        const wrapper = document.createElement('div');
        wrapper.style.marginTop = '8px';
        // pick input type; use number unless unit indicates date or unit is '-'
        let type = 'number';
        if(unit.toLowerCase() === 'date' || q.toLowerCase().includes('date')) type = 'text';
        if(unit === '-' || q.toLowerCase().includes('(text)')) type = 'text';
        const requiredAttr = (type === 'number') ? 'required' : '';
        wrapper.innerHTML = `
          <label>${q}</label>
          <div class="row">
            <input type="${type}" name="${key}" ${requiredAttr} ${type==='number' ? 'step="any"' : ''} style="flex:1;padding:6px" placeholder="${unit}" />
            <div class="small" style="padding:6px">${unit}</div>
          </div>`;
        dyn.appendChild(wrapper);
      });
    } catch(err) {
      dyn.innerHTML = '<p style="color:red">Error loading questions (see console)</p>';
      console.error(err);
    }
  }

  sel.addEventListener('change', () => loadQuestions(sel.value));

  // if process already selected on load, load fields
  if(sel.value) loadQuestions(sel.value);
});
</script>
</body>
</html>
